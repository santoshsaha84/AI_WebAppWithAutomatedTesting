name: Dev Build & Deploy

on:
  push:
    branches: [ "dev" ]
  workflow_dispatch:

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    services:
      # Match local docker-compose: db1 on 5434
      postgres_db1:
        image: postgres:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5434:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      # Match local docker-compose: db2 on 5435
      postgres_db2:
        image: postgres:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5435:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 7.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore

    # App Instance 1 connects to DB1 (5434)
    - name: Start App Instance 1 (Port 5003)
      run: |
        dotnet run --project src/BulkyWeb/BulkyBook.csproj --urls "http://localhost:5003" &
      env:
        ConnectionStrings__DefaultConnection: "Host=localhost;Port=5434;Database=Bulky;Username=postgres;Password=postgres"

    # App Instance 2 connects to DB2 (5435)
    - name: Start App Instance 2 (Port 5004)
      run: |
        dotnet run --project src/BulkyWeb/BulkyBook.csproj --urls "http://localhost:5004" &
      env:
        ConnectionStrings__DefaultConnection: "Host=localhost;Port=5435;Database=Bulky_1;Username=postgres;Password=postgres"

    - name: Wait for Apps to Start
      run: sleep 20

    - name: Run Tests (Unit + UI)
      run: dotnet test
      env:
        HEADLESS: "true"
        # Test code (DatabaseHelper) is already hardcoded to use 5434/5435

    - name: Deploy to Render (Dev)
      if: success()
      run: |
        if [ -n "${{ secrets.RENDER_DEPLOY_HOOK_DEV }}" ]; then
          curl "${{ secrets.RENDER_DEPLOY_HOOK_DEV }}"
        else
          echo "Render Deploy Hook secret not found. Skipping deploy."
        fi
