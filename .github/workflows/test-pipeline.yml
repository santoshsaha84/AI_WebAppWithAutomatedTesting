name: Test Pipeline

on:
  push:
    branches:
      - test
  pull_request:
    branches:
      - test
  workflow_dispatch:

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '7.0.x'

    - name: Restore dependencies
      run: dotnet restore BulkyWeb.sln

    - name: Build solution
      run: dotnet build BulkyWeb.sln --no-restore --configuration Release

    - name: Run unit tests
      run: dotnet test src/BulkyBook.Tests/BulkyBook.Tests.csproj --no-build --configuration Release --verbosity normal

  ui-tests:
    needs: unit-tests
    runs-on: ubuntu-latest
    services:
      db_instance1:
        image: postgres:latest
        env:
          POSTGRES_PASSWORD: postgres
        ports:
          - 5434:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
      db_instance2:
        image: postgres:latest
        env:
          POSTGRES_PASSWORD: postgres
        ports:
          - 5435:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '7.0.x'

    - name: Setup Chrome
      uses: browser-actions/setup-chrome@latest

    - name: Restore dependencies
      run: dotnet restore BulkyWeb.sln

    - name: Build solution
      run: dotnet build BulkyWeb.sln --no-restore --configuration Release

    - name: Wait for databases
      run: sleep 10

    - name: Setup databases
      run: |
        docker exec ${{ job.services.db_instance1.id }} psql -U postgres -c "CREATE DATABASE Bulky;"
        docker exec ${{ job.services.db_instance2.id }} psql -U postgres -c "CREATE DATABASE Bulky_1;"

    - name: Build Docker image
      run: docker build -t bulkyimage1 .

    - name: Start application instance 1
      run: |
        docker run -d \
          --name app-instance1 \
          -p 5003:80 \
          -e ASPNETCORE_ENVIRONMENT=Development \
          -e ConnectionStrings__DefaultConnection="Host=host.docker.internal;Port=5434;Database=Bulky;Username=postgres;Password=postgres" \
          --add-host=host.docker.internal:host-gateway \
          bulkyimage1

    - name: Start application instance 2
      run: |
        docker run -d \
          --name app-instance2 \
          -p 5004:80 \
          -e ASPNETCORE_ENVIRONMENT=Development \
          -e ConnectionStrings__DefaultConnection="Host=host.docker.internal;Port=5435;Database=Bulky_1;Username=postgres;Password=postgres" \
          --add-host=host.docker.internal:host-gateway \
          bulkyimage1

    - name: Wait for apps
      run: |
        timeout 120 bash -c 'until curl -f http://localhost:5003/ || curl -f http://localhost:5003/; do sleep 2; done' || true
        timeout 120 bash -c 'until curl -f http://localhost:5004/ || curl -f http://localhost:5004/; do sleep 2; done' || true
        sleep 5

    - name: Run UI tests
      env:
        HEADLESS: true
      run: |
        dotnet test src/BulkyBook.UITests/BulkyBook.UITests.csproj \
          --no-build \
          --configuration Release \
          --verbosity normal \
          --logger "trx;LogFileName=ui-test-results.trx" \
          -- NUnit.NumberOfTestWorkers=1

    - name: Cleanup
      if: always()
      run: docker stop app-instance1 app-instance2 && docker rm app-instance1 app-instance2 || true
