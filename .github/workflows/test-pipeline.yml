name: Test Pipeline

on:
  push:
    branches:
      - test
  pull_request:
    branches:
      - test
  workflow_dispatch:

jobs:
  all-tests:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '7.0.x'

    - name: Setup Chrome
      uses: browser-actions/setup-chrome@latest

    - name: Restore dependencies
      run: dotnet restore BulkyWeb.sln

    - name: Build solution
      run: dotnet build BulkyWeb.sln --no-restore --configuration Release

    - name: Run unit tests
      run: dotnet test src/BulkyBook.Tests/BulkyBook.Tests.csproj --no-build --configuration Release --verbosity normal

    - name: Build and Start Services with Docker Compose
      run: |
        docker compose build
        docker compose up -d
        echo "Waiting for services to be healthy..."
        # Wait for apps to respond (ignoring 500s initially as they might be migrating)
        timeout 60 bash -c 'until curl -s http://localhost:5003/ > /dev/null; do echo "App 1 still starting..."; sleep 3; done'
        timeout 60 bash -c 'until curl -s http://localhost:5004/ > /dev/null; do echo "App 2 still starting..."; sleep 3; done'
        echo "Applications are responding!"

    - name: Run UI tests
      env:
        HEADLESS: true
      run: |
        dotnet test src/BulkyBook.UITests/BulkyBook.UITests.csproj \
          --no-build \
          --configuration Release \
          --verbosity normal \
          --logger "trx;LogFileName=ui-test-results.trx" \
          -- NUnit.NumberOfTestWorkers=1

    - name: Upload Failure Screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ui-test-screenshots
        path: src/BulkyBook.UITests/bin/Release/net7.0/Screenshots/
        if-no-files-found: ignore

    - name: Debug Logs on Failure
      if: failure()
      run: |
        docker compose logs

    - name: Cleanup
      if: always()
      run: docker compose down || true
