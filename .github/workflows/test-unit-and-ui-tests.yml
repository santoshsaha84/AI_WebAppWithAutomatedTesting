name: Test Branch - Unit and UI Tests

on:
  push:
    branches:
      - test
  pull_request:
    branches:
      - test

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '7.0.x'

    - name: Restore dependencies
      run: dotnet restore BulkyWeb.sln

    - name: Build solution
      run: dotnet build BulkyWeb.sln --no-restore --configuration Release

    - name: Run unit tests
      run: dotnet test src/BulkyBook.Tests/BulkyBook.Tests.csproj --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=unit-test-results.trx" --collect:"XPlat Code Coverage"

    - name: Upload unit test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: '**/unit-test-results.trx'

  ui-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    
    services:
      db_instance1:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: NinjaKing@100s00
          ACCEPT_EULA: Y
        ports:
          - 14330:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -U sa -P NinjaKing@100s00 -Q 'SELECT 1' -C"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

      db_instance2:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: NinjaKing@100s00
          ACCEPT_EULA: Y
        ports:
          - 14340:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -U sa -P NinjaKing@100s00 -Q 'SELECT 1' -C"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '7.0.x'

    - name: Setup Chrome
      uses: browser-actions/setup-chrome@latest

    - name: Restore dependencies
      run: dotnet restore BulkyWeb.sln

    - name: Build solution
      run: dotnet build BulkyWeb.sln --no-restore --configuration Release

    - name: Wait for databases to be ready
      run: |
        echo "Waiting for databases to be ready..."
        for i in {1..30}; do
          if /opt/mssql-tools18/bin/sqlcmd -S localhost,14330 -U sa -P "NinjaKing@100s00" -C -Q "SELECT 1" -b -o /dev/null 2>&1; then
            echo "Database 1 is ready!"
            break
          fi
          echo "Waiting for database 1... ($i/30)"
          sleep 2
        done
        for i in {1..30}; do
          if /opt/mssql-tools18/bin/sqlcmd -S localhost,14340 -U sa -P "NinjaKing@100s00" -C -Q "SELECT 1" -b -o /dev/null 2>&1; then
            echo "Database 2 is ready!"
            break
          fi
          echo "Waiting for database 2... ($i/30)"
          sleep 2
        done

    - name: Setup databases (create if not exists)
      run: |
        # Create databases if they don't exist
        /opt/mssql-tools18/bin/sqlcmd -S localhost,14330 -U sa -P "NinjaKing@100s00" -C -Q "IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'Bulky') CREATE DATABASE Bulky" || true
        /opt/mssql-tools18/bin/sqlcmd -S localhost,14340 -U sa -P "NinjaKing@100s00" -C -Q "IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'Bulky_1') CREATE DATABASE Bulky_1" || true

    - name: Build Docker image
      run: docker build -t bulkyimage1 .

    - name: Start application instance 1
      run: |
        docker run -d \
          --name app-instance1 \
          -p 5003:80 \
          -e ASPNETCORE_ENVIRONMENT=Development \
          -e ConnectionStrings__DefaultConnection="Server=host.docker.internal,14330;Database=Bulky;User Id=sa;Password=NinjaKing@100s00;TrustServerCertificate=True;" \
          --add-host=host.docker.internal:host-gateway \
          bulkyimage1

    - name: Start application instance 2
      run: |
        docker run -d \
          --name app-instance2 \
          -p 5004:80 \
          -e ASPNETCORE_ENVIRONMENT=Development \
          -e ConnectionStrings__DefaultConnection="Server=host.docker.internal,14340;Database=Bulky_1;User Id=sa;Password=NinjaKing@100s00;TrustServerCertificate=True;" \
          --add-host=host.docker.internal:host-gateway \
          bulkyimage1

    - name: Wait for applications to be ready
      run: |
        echo "Waiting for applications to start..."
        timeout 120 bash -c 'until curl -f http://localhost:5003/ || curl -f http://localhost:5003/; do sleep 2; done' || true
        timeout 120 bash -c 'until curl -f http://localhost:5004/ || curl -f http://localhost:5004/; do sleep 2; done' || true
        sleep 10
        echo "Applications should be ready!"

    - name: Run UI tests
      run: |
        dotnet test src/BulkyBook.UITests/BulkyBook.UITests.csproj \
          --no-build \
          --configuration Release \
          --verbosity normal \
          --logger "trx;LogFileName=ui-test-results.trx" \
          -- NUnit.NumberOfTestWorkers=1

    - name: Upload UI test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ui-test-results
        path: '**/ui-test-results.trx'

    - name: Cleanup Docker containers
      if: always()
      run: |
        docker stop app-instance1 app-instance2 || true
        docker rm app-instance1 app-instance2 || true
